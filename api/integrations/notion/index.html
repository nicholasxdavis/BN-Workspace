<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Tool - Blacnova Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #52525b; /* zinc-600 */
            --primary-light: #71717a; /* zinc-500 */
            --dark-bg: #101010;
            --card-bg: #1a1a1a;
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #EEEEEE;
            --text-secondary: #a1a1aa;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--dark-bg); color: var(--text-primary); overflow-x: hidden; }
        #particle-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.7; }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.05); color: var(--text-primary); }
        .sidebar-link.active { box-shadow: inset 3px 0 0 0 var(--primary-light); }
        .form-input, .form-textarea, .form-select { background-color: #2a2a2a; border: 1px solid var(--border-color); border-radius: 0.75rem; transition: all 0.2s ease; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(113, 113, 122, 0.3); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 1.875rem; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-light); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(113, 113, 122, 0.25); }
        .btn-secondary { background-color: #3a3a3a; color: white; }
        .btn-secondary:hover { background-color: #4a4a4a; transform: translateY(-2px); }
        [x-cloak] { display: none !important; }
        .loader { border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .main-content-card { background: linear-gradient(135deg, rgba(26,26,26,0.5) 0%, rgba(10,10,10,0.6) 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 1.5rem; padding: 2.5rem; backdrop-filter: blur(10px); }
        .stat-card { background-color: #161618; border-radius: 1rem; padding: 1.5rem; border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-4px); border-color: var(--primary); }
    </style>
</head>
<body class="h-screen flex" x-data="notionTool()" x-init="init()">
    <canvas id="particle-bg"></canvas>

    <aside class="w-64 bg-[var(--card-bg)]/80 backdrop-blur-lg border-r border-[var(--border-color)] flex flex-col flex-shrink-0 z-10">
        <div class="p-6 border-b border-[var(--border-color)]">
             <h1 class="text-xl font-bold flex items-center">
                 <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Notion-logo.svg/1200px-Notion-logo.svg.png" class="w-7 h-7 mr-3 invert">
                 Notion Tool
             </h1>
             <p class="text-xs text-gray-400 mt-1">Blacnova Workspace</p>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" @click.prevent="activeTab = 'dashboard'" class="sidebar-link flex items-center px-4 py-2 rounded-lg" :class="{ 'active': activeTab === 'dashboard' }">
                <i class="fas fa-home w-6"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" @click.prevent="switchTab('creator')" class="sidebar-link flex items-center px-4 py-2 rounded-lg" :class="{ 'active': activeTab === 'creator' }">
                <i class="fas fa-pen-to-square w-6"></i>
                <span>Page Creator</span>
            </a>
            <a href="#" @click.prevent="activeTab = 'explorer'" class="sidebar-link flex items-center px-4 py-2 rounded-lg" :class="{ 'active': activeTab === 'explorer' }">
                <i class="fas fa-database w-6"></i>
                <span>Database Explorer</span>
            </a>
            <a href="#" @click.prevent="activeTab = 'ai_assistant'" class="sidebar-link flex items-center px-4 py-2 rounded-lg" :class="{ 'active': activeTab === 'ai_assistant' }">
                <i class="fas fa-robot w-6"></i>
                <span>AI Assistant</span>
            </a>
        </nav>
        <div class="p-4 border-t border-[var(--border-color)]">
             <a href="../.." class="text-sm text-gray-400 hover:text-white transition-colors flex items-center"><i class="fas fa-arrow-left mr-2"></i> Back to Workspace</a>
        </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <div x-show="activeTab === 'dashboard'" x-cloak>
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-medium mb-4 text-white" x-text="`Welcome, ${stats.name}`">Welcome</h1>
                <p class="text-lg text-gray-300 max-w-2xl mx-auto">Your Notion workspace at a glance.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="stat-card">
                    <div class="flex items-center text-gray-400 mb-3">
                        <i class="fas fa-file-alt mr-2"></i>
                        <h3 class="text-sm font-medium uppercase tracking-wider">Accessible Pages</h3>
                    </div>
                    <p class="text-4xl font-bold text-white" x-text="stats.page_count"></p>
                </div>
                <div class="stat-card">
                    <div class="flex items-center text-gray-400 mb-3">
                        <i class="fas fa-database mr-2"></i>
                        <h3 class="text-sm font-medium uppercase tracking-wider">Accessible Databases</h3>
                    </div>
                    <p class="text-4xl font-bold text-white" x-text="stats.db_count"></p>
                </div>
            </div>

            <div class="main-content-card">
                <h3 class="text-xl font-bold mb-4">Recently Edited Pages</h3>
                 <div x-show="dashboardLoading" class="flex justify-center items-center h-48"><div class="loader"></div></div>
                 <div x-show="!dashboardLoading && recentPages.length > 0" class="space-y-4">
                    <template x-for="page in recentPages" :key="page.id">
                         <a :href="page.url" target="_blank" rel="noopener noreferrer" class="flex justify-between items-center p-4 bg-[#2a2a2a] rounded-xl border border-transparent hover:border-primary/50 transition-colors">
                            <div>
                                <p class="font-semibold" x-text="page.title"></p>
                                <p class="text-sm text-gray-400" x-text="`Edited: ${page.last_edited}`"></p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-4">
                               <i class="fas fa-external-link-alt text-gray-400"></i>
                            </div>
                        </a>
                    </template>
                </div>
                <p x-show="!dashboardLoading && recentPages.length === 0" class="text-gray-400 text-center py-10">No recent pages found.</p>
            </div>
        </div>

        <div x-show="activeTab === 'creator'" x-cloak>
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-medium mb-4 text-white">Notion Page Creator</h1>
                <p class="text-lg text-gray-300 max-w-2xl mx-auto">Craft and publish new pages directly to your Notion databases.</p>
            </div>
            <div class="main-content-card max-w-4xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="database" class="block text-sm font-medium mb-2">Select Database</label>
                        <select id="database" x-model="creator.database_id" class="form-select w-full px-4 py-3">
                            <option value="">-- Loading Databases --</option>
                            <template x-for="db in databases" :key="db.id">
                                <option :value="db.id" x-text="db.title"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label for="title" class="block text-sm font-medium mb-2">Page Title</label>
                        <input type="text" id="title" x-model="creator.title" class="form-input w-full px-4 py-3" placeholder="My New Brilliant Idea">
                    </div>
                </div>
                <div>
                    <label for="content" class="block text-sm font-medium mb-2">Content</label>
                    <textarea id="content" x-model="creator.content" rows="10" class="form-textarea w-full px-4 py-3" placeholder="Start writing your content here..."></textarea>
                </div>
                <div class="flex flex-col sm:flex-row justify-between items-center mt-6">
                    <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                         <button @click="aiAction('generate', creator.title)" class="btn btn-secondary" :disabled="isLoading || !apiKey">
                            <i class="fas fa-robot mr-2"></i>
                            <span x-show="!isLoading">AI Generate Content</span>
                             <div x-show="isLoading && currentAction === 'generate'" class="loader"></div>
                        </button>
                    </div>
                    <button @click="createPage()" class="btn btn-primary" :disabled="pageCreatorLoading">
                         <span x-show="!pageCreatorLoading">Create Page in Notion</span>
                         <div x-show="pageCreatorLoading" class="loader"></div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Stubs for future features -->
        <div x-show="activeTab === 'explorer'" x-cloak>
             <div class="text-center mb-12"><h1 class="text-4xl font-medium">Database Explorer</h1><p class="text-lg text-gray-300">Feature coming soon.</p></div>
        </div>
         <div x-show="activeTab === 'ai_assistant'" x-cloak>
             <div class="text-center mb-12"><h1 class="text-4xl font-medium">AI Assistant</h1><p class="text-lg text-gray-300">Feature coming soon.</p></div>
        </div>
        
    </main>

    <script>
        function notionTool() {
            return {
                activeTab: 'dashboard',
                isLoading: false,
                currentAction: '',
                dashboardLoading: true,
                pageCreatorLoading: false,
                apiKey: null,
                stats: { name: '', page_count: '...', db_count: '...' },
                recentPages: [],
                databases: [],
                creator: { database_id: '', title: '', content: '' },

                async init() {
                    this.initParticles();
                    await this.loadApiKey();
                    this.loadDashboardData();
                },

                switchTab(tab) {
                    this.activeTab = tab;
                    if (tab === 'creator' && this.databases.length === 0) {
                        this.loadDatabases();
                    }
                },

                async loadApiKey() {
                    try {
                        const response = await fetch(`../../auth/key_handler.php?t=${Date.now()}`);
                        const data = await response.json();
                        if (data.success) this.apiKey = data.apiKey;
                    } catch (error) {
                        console.error("API Key Load Error:", error);
                        this.apiKey = null;
                    }
                },
                
                async loadDashboardData() {
                    this.dashboardLoading = true;
                    try {
                        const response = await fetch(`./notion_api.php?action=dashboard_data&t=${Date.now()}`);
                        if (!response.ok) throw new Error(`Failed to load data. Please re-authenticate Notion if the issue persists. Status: ${response.status}`);
                        const data = await response.json();
                        if (data.success) {
                            this.stats = data.stats;
                            this.recentPages = data.recent_pages;
                        } else {
                            throw new Error(data.error || 'Failed to load dashboard data.');
                        }
                    } catch (error) {
                        alert(`Could not load your Notion data. Error: ${error.message}`);
                    } finally {
                        this.dashboardLoading = false;
                    }
                },

                async loadDatabases() {
                    try {
                        const response = await fetch(`./notion_api.php?action=list_databases&t=${Date.now()}`);
                        const data = await response.json();
                        if (data.success) {
                            this.databases = data.databases;
                            if (this.databases.length > 0) {
                                this.creator.database_id = this.databases[0].id; // Default to the first one
                            }
                        } else {
                           throw new Error(data.error || 'Could not fetch databases.');
                        }
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    }
                },

                async createPage() {
                    if (!this.creator.database_id || !this.creator.title) {
                        alert('Please select a database and provide a title.');
                        return;
                    }
                    this.pageCreatorLoading = true;
                    try {
                        const response = await fetch('./notion_api.php?action=create_page', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.creator)
                        });
                        const result = await response.json();
                        if (result.success) {
                            alert('Successfully created page in Notion!');
                            this.creator.title = '';
                            this.creator.content = '';
                        } else {
                            throw new Error(result.error || 'Failed to create page.');
                        }
                    } catch (error) {
                        alert(`Failed to create page. Error: ${error.message}`);
                    } finally {
                        this.pageCreatorLoading = false;
                    }
                },

                async aiAction(type, inputData) {
                    if (!this.apiKey) {
                        alert('AI features are disabled. API Key not found.');
                        return;
                    }
                    if (this.isLoading) return;
                    this.isLoading = true;
                    this.currentAction = type;

                    let prompt = '';
                    let systemMessage = "You are an expert content creator and writer, specializing in structured and clear communication for platforms like Notion.";
                    
                    try {
                        if (type === 'generate') {
                            if (!inputData) throw new Error("A title or topic is required to generate content.");
                            prompt = `Generate the body content for a Notion page with the title: "${inputData}". Structure the content logically with clear headings (using markdown) and paragraphs. Return only the generated content.`;
                        } else {
                             throw new Error("Invalid AI action type.");
                        }
                        
                        // Simple, non-streaming implementation for now
                        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${this.apiKey}`, "Content-Type": "application/json" },
                            body: JSON.stringify({
                                "model": "deepseek/deepseek-chat",
                                "messages": [ { "role": "system", "content": systemMessage }, { "role": "user", "content": prompt } ],
                            })
                        });

                        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                        const data = await response.json();
                        if (data.choices[0].message.content) {
                            this.creator.content = data.choices[0].message.content;
                        }

                    } catch (error) {
                        alert("An error occurred with the AI Assistant: " + error.message);
                    } finally {
                        this.isLoading = false;
                        this.currentAction = '';
                    }
                },

                initParticles() {
                    // Particle animation code from your other file...
                }
            }
        }
    </script>
</body>
</html>
