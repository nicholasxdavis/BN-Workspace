<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Tool - Blacnova Workspace</title>
    <link rel="icon" href="https://www.blacnova.net/img/bn_orange.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #52525b; /* zinc-600 */
            --primary-light: #71717a; /* zinc-500 */
            --dark-bg: #101010;
            --card-bg: #1a1a1a;
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #EEEEEE;
            --text-secondary: #a1a1aa;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--dark-bg); color: var(--text-primary); overflow-x: hidden; }
        #particle-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.7; }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link.active, .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.05); color: var(--text-primary); }
        .sidebar-link.active { box-shadow: inset 3px 0 0 0 var(--primary-light); }
        .form-input, .form-textarea, .form-select { background-color: #2a2a2a; border: 1px solid var(--border-color); border-radius: 0.75rem; transition: all 0.2s ease; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(113, 113, 122, 0.3); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 1.875rem; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-light); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(113, 113, 122, 0.25); }
        .btn-secondary { background-color: #3a3a3a; color: white; }
        .btn-secondary:hover { background-color: #4a4a4a; transform: translateY(-2px); }
        [x-cloak] { display: none !important; }
        .loader { border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .main-content-card { background: linear-gradient(135deg, rgba(26,26,26,0.5) 0%, rgba(10,10,10,0.6) 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 1.5rem; padding: 2.5rem; backdrop-filter: blur(10px); }
        .stat-card { background-color: #161618; border-radius: 1rem; padding: 1.5rem; border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-4px); border-color: var(--primary); }
        .typing-cursor { display: inline-block; width: 8px; height: 1.2rem; background-color: var(--primary-light); animation: blink 0.7s infinite; vertical-align: middle; }
        @keyframes blink { 50% { opacity: 0; } }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="h-screen flex" x-data="notionTool()" x-init="init()">
    <canvas id="particle-bg"></canvas>
    
    <header class="md:hidden fixed top-0 left-0 w-full bg-[var(--card-bg)]/80 backdrop-blur-lg border-b border-[var(--border-color)] z-20 flex items-center justify-between p-4">
        <h1 class="text-lg font-bold flex items-center">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Notion-logo.svg/1200px-Notion-logo.svg.png" class="w-6 h-6 mr-2 invert">
            Notion Tool
        </h1>
        <button @click="sidebarOpen = !sidebarOpen" class="text-2xl">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <aside :class="{'open': sidebarOpen}" class="sidebar w-64 bg-[var(--card-bg)]/80 backdrop-blur-lg border-r border-[var(--border-color)] flex flex-col flex-shrink-0 z-10 fixed md:relative h-full">
        <div class="p-6 border-b border-[var(--border-color)] hidden md:block">
             <h1 class="text-xl font-bold flex items-center">
                 <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Notion-logo.svg/1200px-Notion-logo.svg.png" class="w-7 h-7 mr-3 invert">
                 Notion Tool
             </h1>
             <p class="text-xs text-gray-400 mt-1">Blacnova Workspace</p>
        </div>
        <nav class="flex-1 p-4 space-y-2 mt-16 md:mt-0">
            <a href="#" @click.prevent="switchTab('dashboard')" class="sidebar-link flex items-center px-4 py-2 rounded-lg" :class="{ 'active': activeTab === 'dashboard' }">
                <i class="fas fa-home w-6"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" @click.prevent="switchTab('creator')" class="sidebar-link flex items-center px-4 py-2 rounded-lg" :class="{ 'active': activeTab === 'creator' }">
                <i class="fas fa-pen-to-square w-6"></i>
                <span>Page Creator</span>
            </a>
            <a href="#" @click.prevent="switchTab('explorer')" class="sidebar-link flex items-center px-4 py-2 rounded-lg" :class="{ 'active': activeTab === 'explorer' }">
                <i class="fas fa-database w-6"></i>
                <span>Database Explorer</span>
            </a>
            <a href="#" @click.prevent="switchTab('ai_assistant')" class="sidebar-link flex items-center px-4 py-2 rounded-lg" :class="{ 'active': activeTab === 'ai_assistant' }">
                <i class="fas fa-robot w-6"></i>
                <span>AI Assistant</span>
            </a>
        </nav>
        <div class="p-4 border-t border-[var(--border-color)]">
             <a href="../../.." class="text-sm text-gray-400 hover:text-white transition-colors flex items-center"><i class="fas fa-arrow-left mr-2"></i> Back to Workspace</a>
        </div>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto mt-16 md:mt-0">
        <div x-show="activeTab === 'dashboard'" x-cloak>
            <div class="text-center mb-12">
                <div class="flex justify-center mb-4"><i class="fas fa-home text-3xl text-primary"></i></div>
                <h1 class="text-4xl md:text-5xl font-medium mb-4 text-white" x-text="`Welcome, ${stats.name}`">Welcome</h1>
                <p class="text-lg text-gray-300 max-w-2xl mx-auto">Your Notion workspace at a glance.</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="stat-card">
                    <div class="flex items-center text-gray-400 mb-3">
                        <i class="fas fa-file-alt mr-2"></i>
                        <h3 class="text-sm font-medium uppercase tracking-wider">Accessible Pages</h3>
                    </div>
                    <p class="text-4xl font-bold text-white" x-text="stats.page_count"></p>
                </div>
                <div class="stat-card">
                    <div class="flex items-center text-gray-400 mb-3">
                        <i class="fas fa-database mr-2"></i>
                        <h3 class="text-sm font-medium uppercase tracking-wider">Accessible Databases</h3>
                    </div>
                    <p class="text-4xl font-bold text-white" x-text="stats.db_count"></p>
                </div>
            </div>

            <div class="main-content-card">
                <h3 class="text-xl font-bold mb-4">Recently Edited Pages</h3>
                 <div x-show="dashboardLoading" class="flex justify-center items-center h-48"><div class="loader"></div></div>
                 <div x-show="!dashboardLoading && recentPages.length > 0" class="space-y-4">
                    <template x-for="page in recentPages" :key="page.id">
                         <a :href="page.url" target="_blank" rel="noopener noreferrer" class="flex justify-between items-center p-4 bg-[#2a2a2a] rounded-xl border border-transparent hover:border-primary/50 transition-colors">
                            <div>
                                <p class="font-semibold" x-text="page.title"></p>
                                <p class="text-sm text-gray-400" x-text="`Edited: ${page.last_edited}`"></p>
                            </div>
                            <div class="text-right flex-shrink-0 ml-4">
                               <i class="fas fa-external-link-alt text-gray-400"></i>
                            </div>
                        </a>
                    </template>
                </div>
                <p x-show="!dashboardLoading && recentPages.length === 0" class="text-gray-400 text-center py-10">No recent pages found.</p>
            </div>
        </div>

        <div x-show="activeTab === 'creator'" x-cloak>
            <div class="text-center mb-12">
                <div class="flex justify-center mb-4"><i class="fas fa-pen-to-square text-3xl text-primary"></i></div>
                <h1 class="text-4xl md:text-5xl font-medium mb-4 text-white">Notion Page Creator</h1>
                <p class="text-lg text-gray-300 max-w-2xl mx-auto">Craft and publish new pages directly to your Notion databases.</p>
            </div>
            <div class="main-content-card max-w-4xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="database" class="block text-sm font-medium mb-2">Select Database</label>
                        <select id="database" x-model="creator.database_id" class="form-select w-full px-4 py-3">
                            <option value="">-- Loading Databases --</option>
                            <template x-for="db in databases" :key="db.id">
                                <option :value="db.id" x-text="db.title"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label for="title" class="block text-sm font-medium mb-2">Page Title</label>
                        <input type="text" id="title" x-model="creator.title" class="form-input w-full px-4 py-3" placeholder="My New Brilliant Idea">
                    </div>
                </div>
                <div>
                    <label for="content" class="block text-sm font-medium mb-2">Content</label>
                    <textarea id="content" x-model="creator.content" rows="10" class="form-textarea w-full px-4 py-3" placeholder="Start writing your content here..."></textarea>
                </div>
                <div class="flex flex-col sm:flex-row justify-end items-center mt-6">
                    <button @click="createPage()" class="btn btn-primary" :disabled="pageCreatorLoading">
                         <span x-show="!pageCreatorLoading">Create Page in Notion</span>
                         <div x-show="pageCreatorLoading" class="loader"></div>
                    </button>
                </div>
            </div>
        </div>

        <div x-show="activeTab === 'explorer'" x-cloak>
            <div class="text-center mb-12">
                <div class="flex justify-center mb-4"><i class="fas fa-database text-3xl text-primary"></i></div>
                <h1 class="text-4xl md:text-5xl font-medium mb-4 text-white">Database Explorer</h1>
                <p class="text-lg text-gray-300 max-w-2xl mx-auto">Select a database to view its pages.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 main-content-card !p-4">
                    <h2 class="text-lg font-bold p-4">Your Databases</h2>
                    <div x-show="explorer.loading" class="flex justify-center p-8"><div class="loader"></div></div>
                    <div class="space-y-2 max-h-[60vh] overflow-y-auto">
                        <template x-for="db in databases" :key="db.id">
                            <button @click="loadDatabaseContent(db)" class="w-full text-left px-4 py-3 rounded-lg transition-colors" :class="explorer.selectedDb && explorer.selectedDb.id === db.id ? 'bg-primary/30' : 'hover:bg-white/5'">
                                <span x-text="db.title"></span>
                            </button>
                        </template>
                    </div>
                </div>
                <div class="md:col-span-2 main-content-card">
                    <div x-show="explorer.selectedDb">
                        <h2 class="text-xl font-bold mb-4" x-text="explorer.selectedDb ? explorer.selectedDb.title : ''"></h2>
                        <div x-show="explorer.loading" class="flex justify-center p-8"><div class="loader"></div></div>
                        <div class="space-y-4" x-show="!explorer.loading">
                             <template x-for="page in explorer.dbContent" :key="page.id">
                                <a :href="page.url" target="_blank" rel="noopener noreferrer" class="flex justify-between items-center p-4 bg-[#2a2a2a] rounded-xl border border-transparent hover:border-primary/50 transition-colors">
                                    <div>
                                        <p class="font-semibold" x-text="page.title"></p>
                                        <p class="text-sm text-gray-400" x-text="`Edited: ${page.last_edited}`"></p>
                                    </div>
                                    <div class="text-right flex-shrink-0 ml-4">
                                       <i class="fas fa-external-link-alt text-gray-400"></i>
                                    </div>
                                </a>
                            </template>
                             <p x-show="explorer.dbContent.length === 0" class="text-gray-400 text-center py-10">This database is empty.</p>
                        </div>
                    </div>
                    <div x-show="!explorer.selectedDb && !explorer.loading" class="text-center py-20 text-gray-400">
                        <i class="fas fa-arrow-left text-3xl mb-4"></i>
                        <p>Select a database from the left to see its content.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div x-show="activeTab === 'ai_assistant'" x-cloak>
            <div class="text-center mb-12">
                <div class="flex justify-center mb-4"><i class="fas fa-robot text-3xl text-primary"></i></div>
                <h1 class="text-4xl md:text-5xl font-medium mb-4 text-white">AI Page Summarizer</h1>
                <p class="text-lg text-gray-300 max-w-2xl mx-auto">Get a concise summary of any Notion page you have access to.</p>
            </div>
            <div class="main-content-card max-w-4xl mx-auto">
                <label for="summarize-url" class="block text-sm font-medium mb-2">Enter a Notion Page URL</label>
                <div class="flex">
                    <input type="text" id="summarize-url" x-model="assistant.url" @keydown.enter="getAiSummary()" class="form-input w-full px-4 py-3 !rounded-r-none" placeholder="https://www.notion.so/...">
                    <button @click="getAiSummary()" class="btn btn-primary !rounded-l-none" :disabled="assistant.loading || !apiKey">
                         <span x-show="!assistant.loading">Summarize</span>
                         <div x-show="assistant.loading" class="loader"></div>
                    </button>
                </div>
                 <div x-show="assistant.summary" class="mt-8 border-t border-[var(--border-color)] pt-8">
                    <h3 class="text-2xl font-bold mb-4">Summary</h3>
                    <div class="prose prose-invert max-w-none text-gray-300" id="summary-results-container"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function notionTool() {
            return {
                sidebarOpen: false,
                activeTab: 'dashboard',
                isLoading: false, // General purpose loader, used for AI
                currentAction: '',
                dashboardLoading: true,
                pageCreatorLoading: false,
                apiKey: null,
                stats: { name: '', page_count: '...', db_count: '...' },
                recentPages: [],
                databases: [], // Single source of truth for databases
                creator: { database_id: '', title: '', content: '' },
                explorer: { selectedDb: null, dbContent: [], loading: false },
                assistant: { url: '', summary: '', loading: false },

                async init() {
                    this.initParticles();
                    await this.loadApiKey();
                    this.loadDashboardData();
                },

                switchTab(tab) {
                    this.activeTab = tab;
                    this.sidebarOpen = false; // Close sidebar on tab change
                    if ((tab === 'creator' || tab === 'explorer') && this.databases.length === 0) {
                        this.loadDatabases();
                    }
                },

                async loadApiKey() {
                    try {
                        const response = await fetch(`../../auth/key_handler.php?t=${Date.now()}`);
                        if (!response.ok) throw new Error(`Could not fetch API key. Status: ${response.status}`);
                        const data = await response.json();
                        if (data.success) this.apiKey = data.apiKey;
                        else throw new Error(data.error || 'Failed to get API key.');
                    } catch (error) {
                        console.error("API Key Load Error:", error);
                        this.apiKey = null;
                    }
                },

                async loadDashboardData() {
                    this.dashboardLoading = true;
                    try {
                        const response = await fetch(`./notion_api.php?action=dashboard_data&t=${Date.now()}`);
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Failed to load data. Please re-authenticate Notion if the issue persists. (Status: ${response.status} - ${errorText})`);
                        }
                        const data = await response.json();
                        if (data.success) {
                            this.stats = data.stats;
                            this.recentPages = data.recent_pages;
                        } else {
                            throw new Error(data.error || 'Failed to load dashboard data.');
                        }
                    } catch (error) {
                        alert(`Could not load your Notion data. Error: ${error.message}`);
                    } finally {
                        this.dashboardLoading = false;
                    }
                },

                async loadDatabases() {
                    this.explorer.loading = true;
                    try {
                        const response = await fetch(`./notion_api.php?action=list_databases&t=${Date.now()}`);
                        const data = await response.json();
                        if (data.success) {
                            this.databases = data.databases;
                            if (this.databases.length > 0 && !this.creator.database_id) {
                                this.creator.database_id = this.databases[0].id;
                            }
                        } else {
                           throw new Error(data.error || 'Could not fetch databases.');
                        }
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    } finally {
                        this.explorer.loading = false;
                    }
                },

                async loadDatabaseContent(db) {
                    this.explorer.selectedDb = db;
                    this.explorer.loading = true;
                    this.explorer.dbContent = [];
                    try {
                         const response = await fetch(`./notion_api.php?action=get_database_content&database_id=${db.id}`);
                         const data = await response.json();
                         if (data.success) {
                             this.explorer.dbContent = data.pages;
                         } else {
                            throw new Error(data.error || 'Could not fetch database content.');
                         }
                    } catch (error) {
                         alert(`Error: ${error.message}`);
                    } finally {
                        this.explorer.loading = false;
                    }
                },

                async createPage() {
                    if (!this.creator.database_id || !this.creator.title) {
                        alert('Please select a database and provide a title.');
                        return;
                    }
                    this.pageCreatorLoading = true;
                    try {
                        const response = await fetch('./notion_api.php?action=create_page', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.creator)
                        });
                        const result = await response.json();
                        if (result.success) {
                            alert('Successfully created page in Notion!');
                            this.creator.title = '';
                            this.creator.content = '';
                        } else {
                            throw new Error(result.error || 'Failed to create page.');
                        }
                    } catch (error) {
                        alert(`Failed to create page. Error: ${error.message}`);
                    } finally {
                        this.pageCreatorLoading = false;
                    }
                },
                
                extractPageId(url) {
                    try {
                        const parsedUrl = new URL(url);
                        if (parsedUrl.hostname !== 'www.notion.so') return null;
                        const path = parsedUrl.pathname.split('/').pop();
                        // Notion URLs end with the page ID, sometimes with a hash. e.g., ...-workspace/Page-Title-1234567890abcdef1234567890abcdef
                        const idMatch = path.match(/([0-9a-f]{32})$/);
                        return idMatch ? idMatch[1] : path.split('-').pop();
                    } catch (e) {
                        return null;
                    }
                },

                async getAiSummary() {
                    const pageId = this.extractPageId(this.assistant.url);
                    if (!pageId) {
                        alert("Invalid Notion page URL provided.");
                        return;
                    }

                    if (!this.apiKey) {
                        alert('AI features are disabled. API Key not found.');
                        return;
                    }
                    if (this.assistant.loading) return;

                    this.assistant.loading = true;
                    this.assistant.summary = '...'; // Indicate loading
                    
                    try {
                        // 1. Fetch page content from our backend
                        const contentResponse = await fetch(`./notion_api.php?action=get_page_content&page_id=${pageId}`);
                        const contentData = await contentResponse.json();

                        if (!contentData.success) {
                             throw new Error(contentData.error || "Could not fetch page content.");
                        }
                        
                        if (!contentData.content.trim()) {
                            this.assistant.summary = "This page appears to be empty or contains only non-text blocks (e.g., images, embeds).";
                            return;
                        }

                        // 2. Stream summary from OpenRouter
                        const prompt = `Please provide a concise summary of the following Notion page content:\n\n---\n\n${contentData.content}`;
                        const systemMessage = "You are an expert AI assistant that specializes in summarizing text content accurately and concisely. Use markdown for formatting.";
                        await this.streamAIResponse(prompt, systemMessage, 'summary-results-container', 'summarize');

                    } catch (error) {
                         alert("An error occurred during summarization: " + error.message);
                         this.assistant.summary = ''; // Clear loading indicator on error
                    } finally {
                        this.assistant.loading = false;
                    }
                },

                formatAIResponse(text) {
                    let formattedText = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>');
                    
                    formattedText = formattedText.replace(/^\s*[\*-]\s*(.*)$/gm, '<li>$1</li>');
                    formattedText = formattedText.replace(/<\/li>\n<li>/g, '</li><li>');
                    if(formattedText.includes('<li>')) {
                       formattedText = `<ul>${formattedText.match(/<li>.*?<\/li>/g).join('')}</ul>`;
                    }
                    
                    return formattedText.replace(/\n/g, '<br>').replace(/<br><ul>/g, '<ul>').replace(/<\/ul><br>/g, '</ul>');
                },

                async streamAIResponse(prompt, systemMessage, elementId, actionType) {
                    let targetElement = document.getElementById(elementId);
                    if (!targetElement) throw new Error(`Element with ID ${elementId} not found.`);
                    
                    targetElement.innerHTML = '';
                    let fullResponse = '';
                    const cursor = '<span class="typing-cursor"></span>';
                    
                    if(actionType === 'summarize') this.assistant.summary = cursor;

                    try {
                        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                            method: "POST",
                            headers: { "Authorization": `Bearer ${this.apiKey}`, "Content-Type": "application/json" },
                            body: JSON.stringify({
                                "model": "deepseek/deepseek-chat",
                                "messages": [ { "role": "system", "content": systemMessage }, { "role": "user", "content": prompt } ],
                                "stream": true
                            })
                        });

                        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                        
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();

                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;
                            
                            const chunk = decoder.decode(value, { stream: true });
                            const lines = chunk.split('\n').filter(line => line.startsWith('data: '));

                            for (const line of lines) {
                                const jsonStr = line.substring(6);
                                if (jsonStr.trim() === '[DONE]') continue;
                                const data = JSON.parse(jsonStr);
                                if (data.choices[0].delta.content) {
                                    fullResponse += data.choices[0].delta.content;
                                    targetElement.innerHTML = this.formatAIResponse(fullResponse) + cursor;
                                }
                            }
                        }
                    } catch (error) {
                        targetElement.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
                        throw error;
                    } finally {
                        targetElement.innerHTML = this.formatAIResponse(fullResponse);
                         if(actionType === 'summarize') this.assistant.summary = fullResponse;
                    }
                },

                initParticles() {
                    const canvas = document.getElementById('particle-bg');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    let particles = [];
                    const particleCount = 70;

                    const resizeCanvas = () => {
                        canvas.width = window.innerWidth;
                        canvas.height = window.innerHeight;
                    };
                    
                    class Particle {
                        constructor() {
                            const colors = [`rgba(255, 255, 255, ${Math.random()*0.2+0.1})`, `rgba(113, 113, 122, ${Math.random()*0.3+0.1})`];
                            this.color = colors[Math.floor(Math.random() * colors.length)];
                            this.radius = Math.random() * 2 + 1;
                            this.x = Math.random() * canvas.width;
                            this.y = Math.random() * canvas.height;
                            this.vx = (Math.random() - 0.5) * 0.4;
                            this.vy = (Math.random() - 0.5) * 0.4;
                        }
                        draw() {
                            ctx.beginPath();
                            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                            ctx.fillStyle = this.color;
                            ctx.fill();
                        }
                        update() {
                            this.x += this.vx;
                            this.y += this.vy;
                            if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                            if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
                        }
                    }

                    for (let i = 0; i < particleCount; i++) particles.push(new Particle());
                    
                    const animate = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        particles.forEach(p => { p.update(); p.draw(); });
                        requestAnimationFrame(animate);
                    };

                    window.addEventListener('resize', resizeCanvas);
                    resizeCanvas();
                    animate();
                }
            }
        }
    </script>
</body>
</html>
